name: Execute ContextBridge Schema

on:
  workflow_dispatch:
    inputs:
      force:
        description: 'Force re-execution even if tables exist'
        required: false
        default: 'false'

jobs:
  execute-schema:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install psycopg2-binary
      
      - name: Execute Schema
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          python << 'EOF'
          import psycopg2
          import os
          
          # Read schema
          with open('migrations/002_complete_schema.sql', 'r') as f:
              schema = f.read()
          
          # Connect to database
          conn = psycopg2.connect(os.environ['SUPABASE_DB_URL'])
          cur = conn.cursor()
          
          print("Executing ContextBridge schema...")
          
          try:
              # Execute schema
              cur.execute(schema)
              conn.commit()
              
              # Verify
              cur.execute("SELECT COUNT(*) FROM target_schools")
              count = cur.fetchone()[0]
              
              print(f"✅ Schema executed successfully!")
              print(f"✅ Verified: {count} target schools inserted")
              
          except Exception as e:
              print(f"Error: {e}")
              conn.rollback()
              raise
          
          finally:
              cur.close()
              conn.close()
          EOF
      
      - name: Summary
        run: |
          echo "✅ ContextBridge schema deployed"
          echo "✅ Database ready for use"
